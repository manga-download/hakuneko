import Connector from '../engine/Connector.mjs';

export default class TuMangaOnline extends Connector {

    constructor() {
        super();
        super.id = 'tumangaonline';
        super.label = 'TuMangaOnline';
        this.tags = [ 'manga', 'spanish' ];
        this.url = 'https://tmofans.com';
        this.requestOptions.headers.set('x-referer', this.url);
    }

    async _initializeConnector() {
        await super._initializeConnector();
        await this.wait(2500);
    }

    async _getMangas() {
        let request = new Request('http://cdn.hakuneko.download/' + this.id + '/mangas.json', this.requestOptions);
        let response = await fetch(request);
        return await response.json();
    }

    async _getChapters(manga) {
        let script = `
            var _0xf99a=['wqHDksKK','w4Q0wqXDvQ==','w51Ow6hk','RlbCiMKrPQ==','w7YCOsKpXQ==','HcOcw4JSZw==','aiDDvw==','w6PCoUzDmGDChBHDvsOX','S8KhEMKhwpE=','BELDlMKhw7ICwprCgy/CscKiBcKjwr3CvUPDgnI=','w7PCm0PDs2k=','wq9DWsO8eQ==','esOjwqNAw6gd','wr7Cg2oU','wplMwoLDpMOH','w6PDtyPDgQg=','wqckw6FqJQ==','w7gxDsKcYQ==','Zl3CjRMm','wpnDu1PClCw=','YCvDljrDlA==','SwTDngLDhA==','wqTDvcO6wqc2woo=','RTfDqjfDuA==','w4wUYl3CkQ==','Tz4HdkstLTXCnBBqw7bDo1jDiMKVTMODwp3DscKvSQMgYW1Iw5xsHcKiw47Cjkhpw6skw6txbHRlOk/DsU0=','QMOowoVyw6U=','ZMKXw5I3dUPDhcOReMK2','wrpvwoXDk8O0','M1pNw7dWwqvCgFRFM8KYOywJwqQGNsOWwq/Du8Oxw7zDgyHDssOMwojCozPCnRvCsVrCkTxyX8KTw4PCsRDDkcKjR8OWwr/Dj0UlwqXCvDsRR24Rw4zDsQYlGMOSXMKUW8OfwpA=','woPDqcKUwqk5','cwlWIXF5w4zDt8Ko','wpXDo1jCvDs=','elTDoT7CnFVYw5XDgMOvwrXClVxUwrNKWsOcY8KAXwfDlUVkw6xgwow/w5MeJnnCvMK4woHCu8K4MQN2w5QZeMKhK8KWe8K1EQcMwqbCnMOLwpFDw4bCvg==','EXjDm8KewqU=','KxHChcKYIw==','WcKuw4k2Ug==','wo4Uw4JpBA==','wq8Nw4J5w4o=','ckXCoCcZ','ByJDw4Q1','w5lKJg==','w5ccNsKkf8OqbDc=','woXCnDnDg8Oj','wooSw7R2C8K0Wg==','wr40RgZ9acKmwpRvw6/CocOEUcOY','YSjDoTI=','wpctw6tZ','RsOyUzg=','w6Y/wpXDnMK8','wqE+w7ZMw7Y=','wobDssOhwp0X'];(function(_0x181db3,_0x322917){var _0xb6eaf3=function(_0x53cd23){while(--_0x53cd23){_0x181db3['push'](_0x181db3['shift']());}};_0xb6eaf3(++_0x322917);}(_0xf99a,0x1b5));var _0x2531=function(_0x181db3,_0x322917){_0x181db3=_0x181db3-0x0;var _0xb6eaf3=_0xf99a[_0x181db3];if(_0x2531['InzVTi']===undefined){(function(){var _0x55371a=function(){var _0x192e9f;try{_0x192e9f=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x518dc3){_0x192e9f=window;}return _0x192e9f;};var _0x263b64=_0x55371a();var _0x5d8663='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=';_0x263b64['atob']||(_0x263b64['atob']=function(_0x4cb241){var _0x2c7281=String(_0x4cb241)['replace'](/=+$/,'');for(var _0x5bc9b9=0x0,_0x13e27b,_0x2c05a2,_0x455c55=0x0,_0x44e961='';_0x2c05a2=_0x2c7281['charAt'](_0x455c55++);~_0x2c05a2&&(_0x13e27b=_0x5bc9b9%0x4?_0x13e27b*0x40+_0x2c05a2:_0x2c05a2,_0x5bc9b9++%0x4)?_0x44e961+=String['fromCharCode'](0xff&_0x13e27b>>(-0x2*_0x5bc9b9&0x6)):0x0){_0x2c05a2=_0x5d8663['indexOf'](_0x2c05a2);}return _0x44e961;});}());var _0x32b002=function(_0x170b10,_0x322917){var _0xf88213=[],_0x321b91=0x0,_0x36edc8,_0x22c541='',_0xac33d3='';_0x170b10=atob(_0x170b10);for(var _0x5aa6d2=0x0,_0x4d7c4c=_0x170b10['length'];_0x5aa6d2<_0x4d7c4c;_0x5aa6d2++){_0xac33d3+='%'+('00'+_0x170b10['charCodeAt'](_0x5aa6d2)['toString'](0x10))['slice'](-0x2);}_0x170b10=decodeURIComponent(_0xac33d3);for(var _0xd2b31e=0x0;_0xd2b31e<0x100;_0xd2b31e++){_0xf88213[_0xd2b31e]=_0xd2b31e;}for(_0xd2b31e=0x0;_0xd2b31e<0x100;_0xd2b31e++){_0x321b91=(_0x321b91+_0xf88213[_0xd2b31e]+_0x322917['charCodeAt'](_0xd2b31e%_0x322917['length']))%0x100;_0x36edc8=_0xf88213[_0xd2b31e];_0xf88213[_0xd2b31e]=_0xf88213[_0x321b91];_0xf88213[_0x321b91]=_0x36edc8;}_0xd2b31e=0x0;_0x321b91=0x0;for(var _0x587f02=0x0;_0x587f02<_0x170b10['length'];_0x587f02++){_0xd2b31e=(_0xd2b31e+0x1)%0x100;_0x321b91=(_0x321b91+_0xf88213[_0xd2b31e])%0x100;_0x36edc8=_0xf88213[_0xd2b31e];_0xf88213[_0xd2b31e]=_0xf88213[_0x321b91];_0xf88213[_0x321b91]=_0x36edc8;_0x22c541+=String['fromCharCode'](_0x170b10['charCodeAt'](_0x587f02)^_0xf88213[(_0xf88213[_0xd2b31e]+_0xf88213[_0x321b91])%0x100]);}return _0x22c541;};_0x2531['EkWUTI']=_0x32b002;_0x2531['ONmhZM']={};_0x2531['InzVTi']=!![];}var _0x24a368=_0x2531['ONmhZM'][_0x181db3];if(_0x24a368===undefined){if(_0x2531['DzxCOL']===undefined){_0x2531['DzxCOL']=!![];}_0xb6eaf3=_0x2531['EkWUTI'](_0xb6eaf3,_0x322917);_0x2531['ONmhZM'][_0x181db3]=_0xb6eaf3;}else{_0xb6eaf3=_0x24a368;}return _0xb6eaf3;};new Promise(_0x268333=>{var _0x5104b9={};_0x5104b9[_0x2531('0x0','5Bu)')]=_0x2531('0x1','wmMQ');_0x5104b9[_0x2531('0x2','5Bu)')]=function(_0x572de0,_0x5988c5){return _0x572de0(_0x5988c5);};_0x5104b9[_0x2531('0x3','xWNr')]=_0x2531('0x4','x#4i');_0x5104b9[_0x2531('0x5','@b[7')]=_0x2531('0x6','11Nr');_0x5104b9[_0x2531('0x7','7A)@')]=_0x2531('0x8','c7$#');_0x5104b9[_0x2531('0x9',']K2j')]=_0x2531('0xa','N31(');_0x5104b9[_0x2531('0xb','6l)T')]=_0x2531('0xc','Ai(8');_0x5104b9[_0x2531('0xd','Q0$j')]=function(_0xbbe93e,_0x25ea24){return _0xbbe93e<_0x25ea24;};_0x5104b9[_0x2531('0xe','5G3p')]=function(_0x106e5e,_0x8d1eea){return _0x106e5e+_0x8d1eea;};_0x5104b9[_0x2531('0xf','11Nr')]=function(_0x3392a4,_0x5c5893){return _0x3392a4+_0x5c5893;};_0x5104b9[_0x2531('0x10','#e8U')]=function(_0x4a663f,_0x20de99,_0x91d245){return _0x4a663f(_0x20de99,_0x91d245);};let _0x50a415={};_0x50a415[_0x5104b9[_0x2531('0x11','570D')]]=[..._0x5104b9[_0x2531('0x12','Z34u')]($,_0x5104b9[_0x2531('0x13','CAag')])][_0x2531('0x14','ZKb]')](_0xdc5cd5=>$(_0xdc5cd5)[_0x2531('0x15','b)]P')]()[_0x2531('0x16','M$wU')]()[_0x2531('0x17','#e8U')](_0x2531('0x18','B8Lh'))[_0x2531('0x19','5Bu)')]('h4')[_0x2531('0x1a','570D')]()[_0x2531('0x1b',']DD#')]());_0x50a415[_0x5104b9[_0x2531('0x1c','qFND')]]=[..._0x5104b9[_0x2531('0x1d','570D')]($,_0x5104b9[_0x2531('0x1e','wmMQ')])][_0x2531('0x1f',']K2j')](_0x372241=>_0x372241[_0x2531('0x20','qFND')][_0x2531('0x21','0lyl')]());_0x50a415[_0x5104b9[_0x2531('0x22','1zLP')]]=[..._0x5104b9[_0x2531('0x23','b)]P')]($,_0x5104b9[_0x2531('0x24','C3dT')])][_0x2531('0x25','5Bu)')](_0x1932f3=>_0x1932f3[_0x2531('0x26','k&C!')][_0x2531('0x27','%cBN')](new RegExp(_0x2531('0x28','Q0$j')))[0x1]);let _0x269600=[];for(let _0x48d99b=0x0;_0x5104b9[_0x2531('0x29','k&C!')](_0x48d99b,_0x50a415[_0x5104b9[_0x2531('0x2a','z[Gi')]][_0x2531('0x2b','@b[7')]);_0x48d99b++){_0x269600[_0x2531('0x2c',']Gwq')]({'id':_0x48d99b,'title':_0x5104b9[_0x2531('0x2d','7A)@')](_0x5104b9[_0x2531('0x2e','sdDR')](_0x5104b9[_0x2531('0x2f','#e8U')](_0x50a415[_0x5104b9[_0x2531('0x30','b)]P')]][_0x48d99b],'\x20['),_0x50a415[_0x5104b9[_0x2531('0x31','Z34u')]][_0x48d99b]),']'),'language':_0x50a415[_0x5104b9[_0x2531('0x32','6l)T')]][_0x48d99b]});}_0x5104b9[_0x2531('0x33','5Bu)')](setTimeout,()=>_0x268333(_0x269600),0x1388);});
        `;
        let request = new Request(this.url + manga.id, this.requestOptions);
        return await Engine.Request.fetchUI(request, script);
    }

    async _getPages(chapter) {
        let script = `
            window['uri'] = new URL('${chapter.id}', '${this.url}');
            var _0x5d22=['w4TDp8K6','wrbDnURFw4IhKho=','wrUJFVtA','w7Zlwp5Iw5o=','w6/CsMKJwofCuQ==','w4o0PVXDjg==','woEHGD0sw7psG8Okw4MBMMKAw4FtwpLDm8KtV3x9w57DsSh/wrjCmcKmwp8cEsKSDMOOw5h+w4IaSWopw6BZJcO6w7XDt2TCv8KUw6vCuMOVaMKIPsKGwpHCqMO4OMKqFcKO','woIFLXYc','wrDDvhEKEg==','VsO4wqHDr2bDmDQFwpw=','wpUhwolhw58=','w5nDp8K2FgzDjmk=','Qytdw4jDqw==','w4xWw44=','asOHw6DDgsOj','w5rDo8Krw7HDmcO4','wrsOwoVrw4Q=','wo4LwoFqw5o=','w5jDizZ/ZQ==','aMKMBQ==','fMK3F8KNwoU=','wpLDgWRxw7E=','w6XDisK/Pz/CtsK3wpnDisOww6jChGvDgQMCw4Y+wrJqbcKbHlIZVEtdw6h4wrRXLAgfw4oLDsKJTVhyw4Vuwqdq','KcKKFkM=','N8Ocw7gT','SWHDq8OIw7g=','w4XDlsOZHsK3','wrrDvDADKg==','W8KQOcK4wok=','Z3FxXws=','ZCo6w6TCkWM=','woEPGn8=','w6Q+Mn3DlmNbwps=','w75Pw5PDosO4','w5kjwqTDq34=','w48AwovDi1s=','wpM1OcKzQw==','w6MHEzvCvcO3w6A=','w7bDtsOIDcKN','wo9aVcOaw5o=','dsO0wojDlUM=','w5UzRkrCgMKSwp0=','w5MBPCzCnQ==','w6fDty1VXw==','OMKBIHA3','GMK7B1Y4','wqd1VsOc','WFE9w5hI','V8Oww5c=','wpnDox0=','X8KhO8Ktwqs=','TU/Dt2/CrQ==','DsKZwonDkz4=','TGnDp0HClg==','Wh59w6VY','wo0CKsOZwqM='];(function(_0x22cae5,_0x81dc3b){var _0x3372c7=function(_0x2d017b){while(--_0x2d017b){_0x22cae5['push'](_0x22cae5['shift']());}};_0x3372c7(++_0x81dc3b);}(_0x5d22,0xe4));var _0x2a17=function(_0x123678,_0x3b972c){_0x123678=_0x123678-0x0;var _0x364533=_0x5d22[_0x123678];if(_0x2a17['ANDKJx']===undefined){(function(){var _0x379ac8=function(){var _0x47757a;try{_0x47757a=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(_0x16e9ad){_0x47757a=window;}return _0x47757a;};var _0x135fa1=_0x379ac8();var _0xa481f4='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=';_0x135fa1['atob']||(_0x135fa1['atob']=function(_0x21e2e5){var _0xf0d36b=String(_0x21e2e5)['replace'](/=+$/,'');for(var _0x347063=0x0,_0x3f9970,_0x3a5fd9,_0x517fb7=0x0,_0x39be17='';_0x3a5fd9=_0xf0d36b['charAt'](_0x517fb7++);~_0x3a5fd9&&(_0x3f9970=_0x347063%0x4?_0x3f9970*0x40+_0x3a5fd9:_0x3a5fd9,_0x347063++%0x4)?_0x39be17+=String['fromCharCode'](0xff&_0x3f9970>>(-0x2*_0x347063&0x6)):0x0){_0x3a5fd9=_0xa481f4['indexOf'](_0x3a5fd9);}return _0x39be17;});}());var _0x22f009=function(_0x59767d,_0x3b972c){var _0x554343=[],_0x15e95b=0x0,_0x20b7be,_0x912153='',_0x45663d='';_0x59767d=atob(_0x59767d);for(var _0x4e24a4=0x0,_0x474913=_0x59767d['length'];_0x4e24a4<_0x474913;_0x4e24a4++){_0x45663d+='%'+('00'+_0x59767d['charCodeAt'](_0x4e24a4)['toString'](0x10))['slice'](-0x2);}_0x59767d=decodeURIComponent(_0x45663d);for(var _0x3e05a8=0x0;_0x3e05a8<0x100;_0x3e05a8++){_0x554343[_0x3e05a8]=_0x3e05a8;}for(_0x3e05a8=0x0;_0x3e05a8<0x100;_0x3e05a8++){_0x15e95b=(_0x15e95b+_0x554343[_0x3e05a8]+_0x3b972c['charCodeAt'](_0x3e05a8%_0x3b972c['length']))%0x100;_0x20b7be=_0x554343[_0x3e05a8];_0x554343[_0x3e05a8]=_0x554343[_0x15e95b];_0x554343[_0x15e95b]=_0x20b7be;}_0x3e05a8=0x0;_0x15e95b=0x0;for(var _0x19dc32=0x0;_0x19dc32<_0x59767d['length'];_0x19dc32++){_0x3e05a8=(_0x3e05a8+0x1)%0x100;_0x15e95b=(_0x15e95b+_0x554343[_0x3e05a8])%0x100;_0x20b7be=_0x554343[_0x3e05a8];_0x554343[_0x3e05a8]=_0x554343[_0x15e95b];_0x554343[_0x15e95b]=_0x20b7be;_0x912153+=String['fromCharCode'](_0x59767d['charCodeAt'](_0x19dc32)^_0x554343[(_0x554343[_0x3e05a8]+_0x554343[_0x15e95b])%0x100]);}return _0x912153;};_0x2a17['agGZcG']=_0x22f009;_0x2a17['VDgNDp']={};_0x2a17['ANDKJx']=!![];}var _0x121e18=_0x2a17['VDgNDp'][_0x123678];if(_0x121e18===undefined){if(_0x2a17['gMFgAl']===undefined){_0x2a17['gMFgAl']=!![];}_0x364533=_0x2a17['agGZcG'](_0x364533,_0x3b972c);_0x2a17['VDgNDp'][_0x123678]=_0x364533;}else{_0x364533=_0x121e18;}return _0x364533;};new Promise((_0x376b31,_0x15c8c7)=>{var _0x1871ef={};_0x1871ef[_0x2a17('0x0','LKA@')]=function(_0x554c4a,_0x1f3f39){return _0x554c4a(_0x1f3f39);};_0x1871ef[_0x2a17('0x1','Z4Xz')]=_0x2a17('0x2','FnCa');_0x1871ef[_0x2a17('0x3','FnCa')]=function(_0x52ff4d,_0x82bb45){return _0x52ff4d(_0x82bb45);};_0x1871ef[_0x2a17('0x4','5Ant')]=_0x2a17('0x5','A%@c');_0x1871ef[_0x2a17('0x6','xEJ6')]=_0x2a17('0x7','beQU');_0x1871ef[_0x2a17('0x8','mhHc')]=_0x2a17('0x9','qnPo');_0x1871ef[_0x2a17('0xa','M^G]')]=_0x2a17('0xb','AoSi');_0x1871ef[_0x2a17('0xc','xEJ6')]=_0x2a17('0xd','xEJ6');_0x1871ef[_0x2a17('0xe','J3iB')]=_0x2a17('0xf','(VdO');_0x1871ef[_0x2a17('0x10','(VdO')]=function(_0x43870f,_0x7ada77){return _0x43870f(_0x7ada77);};_0x1871ef[_0x2a17('0x11','7Ak1')]=_0x2a17('0x12','U)E9');let _0x232ab3=$[_0x2a17('0x13','Hj2M')];$[_0x2a17('0x14','(E1y')]=_0x51b50e=>{var _0x98d9a5={};_0x98d9a5[_0x2a17('0x15','rPca')]=function(_0xe0bfa9,_0x1111bf){return _0x1871ef.QDaqm(_0xe0bfa9,_0x1111bf);};_0x98d9a5[_0x2a17('0x16','dVZq')]=_0x1871ef.GdlDm;_0x98d9a5[_0x2a17('0x17','5Ant')]=function(_0x10adc4,_0x5b0eee){return _0x1871ef.gkChF(_0x10adc4,_0x5b0eee);};_0x98d9a5[_0x2a17('0x18','(VdO')]=_0x1871ef.ZooZs;_0x98d9a5[_0x2a17('0x19','mYI#')]=_0x1871ef.hZdbq;if(Object[_0x2a17('0x1a','wbW%')](_0x51b50e[_0x2a17('0x1b','FnCa')])[_0x2a17('0x1c','Z4Xz')](window[_0x1871ef[_0x2a17('0x1d','qnPo')]][_0x1871ef[_0x2a17('0x1e','s!1F')]][_0x1871ef[_0x2a17('0x1f','s!1F')]]('=')[_0x1871ef[_0x2a17('0x20',')%&O')]]())){_0x51b50e[_0x2a17('0x21','I2dN')]=_0x32e439=>{var _0x4c5ec3={};_0x4c5ec3[_0x2a17('0x22','dVZq')]=function(_0x52d8cd,_0x5ca63e){return _0x98d9a5.GBNag(_0x52d8cd,_0x5ca63e);};_0x4c5ec3[_0x2a17('0x23','f050')]=_0x98d9a5.CAFXM;_0x98d9a5[_0x2a17('0x24','A%@c')](_0x232ab3,{'url':_0x32e439[_0x2a17('0x25','O[st')](_0x98d9a5[_0x2a17('0x26','I2dN')],_0x98d9a5[_0x2a17('0x27','J3iB')]),'success':_0x133c61=>{_0x4c5ec3[_0x2a17('0x28','Hj2M')](_0x376b31,[..._0x4c5ec3[_0x2a17('0x29','UdFi')]($,_0x133c61)[_0x2a17('0x2a','f050')](_0x4c5ec3[_0x2a17('0x2b','&#lW')])][_0x2a17('0x2c','M^G]')](_0x32b661=>_0x32b661[_0x2a17('0x2d','5Ant')]));},'error':(_0x20fea8,_0x2cc48c,_0x2cd2e0)=>{_0x98d9a5[_0x2a17('0x2e','(VdO')](_0x15c8c7,_0x2cd2e0);}});};_0x51b50e[_0x2a17('0x2f','HiW1')]=(_0x5a76ab,_0x5c889d,_0x30a214)=>{_0x1871ef[_0x2a17('0x30','SdGo')](_0x15c8c7,_0x30a214);};_0x1871ef[_0x2a17('0x31','HiW1')](_0x232ab3,_0x51b50e);}};[..._0x1871ef[_0x2a17('0x32','rBfp')]($,_0x1871ef[_0x2a17('0x33','z$]R')])][_0x2a17('0x34','AoSi')](_0x5df80d=>{_0x5df80d=_0x1871ef[_0x2a17('0x31','HiW1')]($,_0x5df80d)[_0x2a17('0x35','7Ak1')]()[_0x2a17('0x36','iBF[')]();_0x5df80d[_0x2a17('0x37','7OUL')]();});});
        `;
        let request = new Request(this.url + chapter.manga.id, this.requestOptions);
        let data = await Engine.Request.fetchUI(request, script);
        return data.map(img => this.createConnectorURI({
            url: this.getAbsolutePath(img, request.url),
            referer: request.url
        }));
    }

    _handleConnectorURI( payload ) {
        /*
         * TODO: only perform requests when from download manager
         * or when from browser for preview and selected chapter matches
         */
        this.requestOptions.headers.set( 'x-referer', payload.referer );
        let promise = super._handleConnectorURI( payload.url );
        this.requestOptions.headers.delete( 'x-referer' );
        return promise;
    }
}